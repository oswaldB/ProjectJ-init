{% extends "jaffar/base.html" %}

{% block title %}Issues Grid{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.1/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.1/styles/ag-theme-alpine-dark.css">
<script src="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@30.2.1/dist/ag-grid-enterprise.min.js"></script>
<style>
  .grid-container {
    height: calc(100vh - 120px);
    width: 100%;
    margin-top: 20px;
  }
</style>
{% endblock %}

{% block content %}
<div class="p-6">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-white">Issues Grid</h1>
  </div>

  <div id="grid" class="ag-theme-alpine-dark grid-container"></div>
</div>

<script>
let gridApi;

const columnDefs = [
  { field: 'id', sortable: true, filter: true },
  { field: 'status', sortable: true, filter: true },
  { field: 'version', sortable: true, filter: true },
  { field: 'name', sortable: true, filter: true },
  { field: 'issue-description', headerName: 'Description', sortable: true, filter: true },
  { field: 'asset-class', headerName: 'Asset Class', sortable: true, filter: true, valueFormatter: params => Array.isArray(params.value) ? params.value.join(', ') : params.value },
  { field: 'business-unit', headerName: 'Business Unit', sortable: true, filter: true, valueFormatter: params => Array.isArray(params.value) ? params.value.join(', ') : params.value },
  { field: 'region', sortable: true, filter: true, valueFormatter: params => Array.isArray(params.value) ? params.value.join(', ') : params.value },
  { field: 'pc-function', headerName: 'PC Function', sortable: true, filter: true },
  { field: 'issue-family', headerName: 'Issue Family', sortable: true, filter: true },
  { field: 'control-pillar', headerName: 'Control Pillar', sortable: true, filter: true, valueFormatter: params => Array.isArray(params.value) ? params.value.join(', ') : params.value },
  { field: 'date-identification', headerName: 'Date Identification', sortable: true, filter: true },
  { field: 'impact-breach-start-date', headerName: 'Impact Breach Start Date', sortable: true, filter: true },
  { field: 'author', sortable: true, filter: true },
  { field: 'created_at', headerName: 'Created At', sortable: true, filter: true, valueFormatter: params => params.value ? new Date(params.value).toLocaleString() : '' },
  { field: 'updated_at', headerName: 'Updated At', sortable: true, filter: true, valueFormatter: params => params.value ? new Date(params.value).toLocaleString() : '' },
  { field: 'submitted_at', headerName: 'Submitted At', sortable: true, filter: true, valueFormatter: params => params.value ? new Date(params.value).toLocaleString() : '' }
];

async function loadData() {
  const response = await fetch('/api/jaffar/issues/list');
  if (response.ok) {
    const data = await response.json();
    const issues = data.filter(issue => issue.version);
    const gridOptions = {
      columnDefs: columnDefs,
      rowData: issues,
      defaultColDef: {
        flex: 1,
        minWidth: 150,
        resizable: true
      },
      enableRangeSelection: true,
      copyHeadersToClipboard: true,
      rowSelection: 'multiple',
      onGridReady: params => {
        gridApi = params.api;
        params.api.sizeColumnsToFit();
      }
    };

    new agGrid.Grid(document.getElementById('grid'), gridOptions);
  }
}

// Load data when page loads
document.addEventListener('DOMContentLoaded', loadData);

// Handle window resize
window.addEventListener('resize', () => {
  if (gridApi) {
    gridApi.sizeColumnsToFit();
  }
});
</script>
{% endblock %}