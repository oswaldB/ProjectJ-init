
{% extends "sultan/base.html" %}

{% block title %}Workflow Editor{% endblock %}

{% block alpine_component %}{
  workflow: {
    id: '',
    name: '',
    description: '',
    blocks: []
  },
  templates: [],
  emailGroups: [],
  forms: [],
  formKeys: [],
  availableBlocks: [
    { type: 'trigger', name: 'Trigger', icon: 'play', color: 'blue' },
    { type: 'filter', name: 'Filter', icon: 'filter', color: 'purple' },
    { type: 'email', name: 'Send Email', icon: 'mail', color: 'green' },
    { type: 'code', name: 'Execute Code', icon: 'code', color: 'yellow' },
    { type: 'search', name: 'Search Engine', icon: 'search', color: 'cyan' }
  ],
  draggedBlock: null,

  async init() {
    const id = window.location.pathname.split('/').pop();
    if (id === 'new') {
      this.workflow = {
        id: `workflow-${Date.now()}`,
        name: 'New Workflow',
        description: '',
        blocks: [{
          id: `block-${Date.now()}`,
          type: 'trigger',
          position: { x: 100, y: 100 },
          formId: '',
          event: 'on_submit'
        }]
      };
    } else {
      await this.loadWorkflow(id);
    }
    await this.loadTemplates();
    await this.loadEmailGroups();
    await this.loadForms();
  },

  async loadWorkflow(id) {
    try {
      const response = await fetch(`/api/sultan/workflows/${id}`);
      const data = await response.json();
      this.workflow = data;
    } catch (error) {
      console.error('Failed to load workflow:', error);
    }
  },

  async loadTemplates() {
    try {
      const response = await fetch('/api/sultan/templates');
      this.templates = await response.json();
    } catch (error) {
      console.error('Failed to load templates:', error);
      this.templates = [];
    }
  },

  async loadEmailGroups() {
    try {
      const response = await fetch('/api/sultan/emailgroups/list');
      this.emailGroups = await response.json();
    } catch (error) {
      console.error('Failed to load email groups:', error);
      this.emailGroups = [];
    }
  },

  async loadForms() {
    try {
      const response = await fetch('/api/sultan/forms/list');
      this.forms = await response.json();
    } catch (error) {
      console.error('Failed to load forms:', error);
      this.forms = [];
    }
  },

  async loadFormKeys(formId) {
    if (!formId) {
      this.formKeys = [];
      return;
    }
    try {
      const response = await fetch(`/api/sultan/forms/${formId}`);
      const formData = await response.json();

      const keys = [];
      if (formData.fields) {
        formData.fields.forEach(field => {
          if (field.key) {
            keys.push(field.key);
          }
          if (field.options) {
            field.options.forEach(option => {
              if (option.questions) {
                option.questions.forEach(question => {
                  if (question.key) {
                    keys.push(question.key);
                  }
                });
              }
            });
          }
        });
      }
      this.formKeys = keys;
    } catch (error) {
      console.error('Failed to load form keys:', error);
      this.formKeys = [];
    }
  },

  addBlock(blockType) {
    const newBlock = {
      id: `block-${Date.now()}`,
      type: blockType,
      position: { x: 200, y: this.workflow.blocks.length * 150 + 100 }
    };

    // Initialize block-specific properties
    switch(blockType) {
      case 'filter':
        newBlock.operator = 'AND';
        newBlock.conditions = [{ key: '', operator: 'equals', value: '' }];
        break;
      case 'email':
        newBlock.templateId = '';
        newBlock.emailGroupId = '';
        newBlock.delay = 0;
        break;
      case 'code':
        newBlock.code = '# Write your Python code here\nprint("Hello from workflow!")';
        break;
      case 'search':
        newBlock.searchType = 'forms';
        newBlock.query = '';
        newBlock.maxResults = 10;
        newBlock.sortBy = 'relevance';
        break;
    }

    this.workflow.blocks.push(newBlock);
  },

  removeBlock(blockIndex) {
    // Don't allow removing the trigger block (first block)
    if (blockIndex === 0) {
      alert('Cannot remove the trigger block');
      return;
    }
    this.workflow.blocks.splice(blockIndex, 1);
  },

  getBlockTemplate(blockType) {
    switch(blockType) {
      case 'trigger': return 'templates/sultan/workflows/actions/trigger.html';
      case 'filter': return 'templates/sultan/workflows/actions/filter.html';
      case 'email': return 'templates/sultan/workflows/actions/email.html';
      case 'code': return 'templates/sultan/workflows/actions/code.html';
      case 'search': return 'templates/sultan/workflows/actions/search.html';
      default: return '';
    }
  },

  async save() {
    try {
      const response = await fetch('/api/sultan/workflows/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({workflows: [this.workflow]})
      });

      if (response.ok) {
        alert('Workflow saved successfully!');
        window.location.href = '/sultan/workflows';
      } else {
        throw new Error('Error saving workflow');
      }
    } catch (error) {
      console.error('Failed to save workflow:', error);
      alert('Error saving workflow');
    }
  },

  downloadJson() {
    const dataStr = JSON.stringify(this.workflow, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `workflow-${this.workflow.id}.json`;
    link.click();
    URL.revokeObjectURL(url);
  }
}{% endblock %}

{% block content %}
<div class="h-screen bg-gray-900 text-white flex">
  <!-- Sidebar with block palette -->
  <div class="w-64 bg-gray-800 border-r border-gray-700 p-4">
    <h2 class="text-lg font-semibold mb-4">Block Palette</h2>
    <div class="space-y-2">
      <template x-for="blockType in availableBlocks.slice(1)" :key="blockType.type">
        <button 
          @click="addBlock(blockType.type)"
          :class="`w-full text-left p-3 rounded border-2 border-${blockType.color}-600 bg-${blockType.color}-900 hover:bg-${blockType.color}-800 transition-colors`">
          <div class="flex items-center space-x-2">
            <div :class="`w-3 h-3 bg-${blockType.color}-500 rounded-full`"></div>
            <span x-text="blockType.name"></span>
          </div>
        </button>
      </template>
    </div>
  </div>

  <!-- Main content area -->
  <div class="flex-1 flex flex-col">
    <!-- Top Bar -->
    <div class="p-4 bg-gray-800 border-b border-gray-700">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-4">
          <input type="text" x-model="workflow.name" class="bg-gray-700 text-white px-3 py-2 rounded border border-gray-600 text-lg font-semibold">
          <input type="text" x-model="workflow.description" placeholder="Workflow description" class="bg-gray-700 text-white px-3 py-2 rounded border border-gray-600">
        </div>
        <div class="flex space-x-2">
          <button @click="downloadJson()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            Download JSON
          </button>
          <button @click="save()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            Save
          </button>
        </div>
      </div>
    </div>

    <!-- Workflow Canvas -->
    <div class="flex-1 p-6 overflow-y-auto">
      <div class="space-y-6">
        <template x-for="(block, blockIndex) in workflow.blocks" :key="block.id">
          <div>
            <!-- Trigger Block -->
            <template x-if="block.type === 'trigger'">
              {% include 'sultan/workflows/actions/trigger.html' %}
            </template>

            <!-- Filter Block -->
            <template x-if="block.type === 'filter'">
              {% include 'sultan/workflows/actions/filter.html' %}
            </template>

            <!-- Email Block -->
            <template x-if="block.type === 'email'">
              {% include 'sultan/workflows/actions/email.html' %}
            </template>

            <!-- Code Block -->
            <template x-if="block.type === 'code'">
              {% include 'sultan/workflows/actions/code.html' %}
            </template>

            <!-- Search Block -->
            <template x-if="block.type === 'search'">
              {% include 'sultan/workflows/actions/search.html' %}
            </template>
          </div>
        </template>
      </div>
    </div>
  </div>
</div>
{% endblock %}
