
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <title>Sultan - {% block title %}{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@9.0.0/dist/pouchdb.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@9.0.0/dist/pouchdb.find.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/pouchdb-community/pouchdb-quick-search@master/dist/pouchdb.quick-search.min.js"></script>
    <!-- Quill JS and Alpine integration -->
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
    
    <!-- Include PouchDB Service -->
    {% include "services/pouchdb.html" %}
    
    <script>
    // Initialize Quill editors
    window.initQuill = function(element, onChange) {
        if (!element) return;
        
        const quill = new Quill(element, {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    ['link'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['clean']
                ]
            }
        });
        
        // Set initial content if available
        if (onChange) {
            quill.on('text-change', () => {
                onChange(quill.root.innerHTML);
            });
        }
        
        return quill;
    };

    // Global notification system
    window.showNotification = function(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
            type === 'error' ? 'bg-red-600' : 
            type === 'success' ? 'bg-green-600' : 
            type === 'warning' ? 'bg-yellow-600' : 'bg-blue-600'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Remove after 5 seconds
        setTimeout(() => {
            notification.remove();
        }, 5000);
    };
    </script>
</head>
<body class="bg-gray-900 text-white">
    <div class="flex h-screen">
        <!-- Sidebar -->
        {% include "sultan/menu.html" %}
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            {% block content %}{% endblock %}
        </div>
    </div>
    
    <!-- Sync Progress Indicator -->
    <div id="sync-indicator" 
         x-data="syncIndicator()" 
         x-show="hasSyncs" 
         class="fixed bottom-4 right-4 bg-gray-800 border border-gray-600 rounded-lg p-4 max-w-sm z-50">
        <h4 class="text-white font-semibold mb-2">Data Sync Progress</h4>
        <template x-for="(status, dbName) in syncStatuses" :key="dbName">
            <div class="mb-2 last:mb-0">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm text-gray-300" x-text="dbName"></span>
                    <span class="text-xs" 
                          :class="{
                            'text-green-400': status.status === 'completed',
                            'text-red-400': status.status === 'error',
                            'text-blue-400': status.status === 'syncing' || status.status === 'fetching',
                            'text-yellow-400': status.status === 'starting' || status.status === 'clearing',
                            'text-gray-400': status.status === 'idle'
                          }"
                          x-text="status.status"></span>
                </div>
                <div x-show="status.total > 0" class="bg-gray-700 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full transition-all duration-300"
                         :style="`width: ${status.total > 0 ? (status.progress / status.total) * 100 : 0}%`"></div>
                </div>
                <div x-show="status.total > 0" class="text-xs text-gray-400 mt-1" 
                     x-text="`${status.progress}/${status.total}`"></div>
                <div x-show="status.error" class="text-xs text-red-400 mt-1" x-text="status.error"></div>
            </div>
        </template>
    </div>

    <script>
        function syncIndicator() {
            return {
                syncStatuses: {},
                hasSyncs: false,
                
                init() {
                    // Listen for sync progress updates
                    window.addEventListener('pouchdb-sync-progress', (event) => {
                        const { dbName, progress } = event.detail;
                        this.syncStatuses[dbName] = progress;
                        this.updateHasSyncs();
                    });
                    
                    // Periodic check for sync statuses
                    setInterval(() => {
                        if (window.getAllSyncStatuses) {
                            const statuses = window.getAllSyncStatuses();
                            this.syncStatuses = statuses;
                            this.updateHasSyncs();
                        }
                    }, 1000);
                },
                
                updateHasSyncs() {
                    this.hasSyncs = Object.values(this.syncStatuses).some(status => 
                        status.status !== 'idle' && status.status !== 'completed'
                    );
                }
            };
        }
    </script>
</body>
</html>
