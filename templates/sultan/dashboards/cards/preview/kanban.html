
<div class="bg-gray-800 p-4 rounded-lg h-full"
     :style="{
       minHeight: card.size.height === 1 ? '200px' : 
                 card.size.height === 2 ? '300px' : 
                 card.size.height === 3 ? '400px' : 
                 card.size.height === 4 ? '500px' : '600px'
     }"
     x-data="{
  kanbanData: [],
  filteredData: [],
  loading: false,
  filterQuery: '',
  
  async loadKanbanData() {
    if (!card.config.dataSource) return;
    
    this.loading = true;
    try {
      // Extract form ID from data source URL
      let formId = null;
      let isDrafts = false;
      
      if (card.config.dataSource.startsWith('/pc-analytics-jaffar/forms/api/pouchdb/init/')) {
        formId = card.config.dataSource.split('/').pop();
      } else if (card.config.dataSource.includes('forms/')) {
        const parts = card.config.dataSource.split('/');
        const formsIndex = parts.indexOf('forms');
        if (formsIndex >= 0 && formsIndex < parts.length - 1) {
          formId = parts[formsIndex + 1];
        }
      }
      
      if (!formId) {
        console.error('Could not extract form ID from data source:', card.config.dataSource);
        return;
      }
      
      // Check if it's a drafts database
      isDrafts = formId.endsWith('_drafts');
      const cleanFormId = isDrafts ? formId.replace('_drafts', '') : formId;
      
      console.log('Loading kanban data from PouchDB for form:', cleanFormId, 'isDrafts:', isDrafts);
      
      // Initialize PouchDB for the form
      await initializePouchDB(formId);
      const pouchDB = new PouchDB(formId);
      
      // Get all documents from PouchDB
      const result = await pouchDB.allDocs({ include_docs: true });
      this.kanbanData = result.rows.map(row => row.doc).filter(doc => !doc._id.startsWith('_design/'));
      this.filteredData = this.kanbanData;
      
      console.log('Loaded kanban data:', this.kanbanData.length, 'items');
    } catch (error) {
      console.error('Error loading kanban data:', error);
      this.kanbanData = [];
    } finally {
      this.loading = false;
    }
  },

  async performFilter() {
    if (!this.filterQuery.trim()) {
      this.filteredData = this.kanbanData;
      return;
    }

    if (!card.config.dataSource) return;

    try {
      const formId = card.config.dataSource.split('/').pop();
      const pouchDB = new PouchDB(formId);

      // Build a flexible search selector that searches across multiple fields
      const searchTerms = this.filterQuery.toLowerCase().split(' ').filter(term => term.length > 0);
      
      // Create OR conditions for each search term across common fields
      const orConditions = [];
      
      // Common field names to search in
      const searchFields = ['name', 'title', 'description', 'status', 'type', 'category', 'assignee', 'priority'];
      
      for (const term of searchTerms) {
        const fieldConditions = [];
        
        // Search in each field
        for (const field of searchFields) {
          fieldConditions.push({
            [field]: { $regex: new RegExp(term, 'i') }
          });
        }
        
        // Also search in any field that might contain the term (for dynamic fields)
        orConditions.push({ $or: fieldConditions });
      }

      let selector = {};
      if (orConditions.length === 1) {
        selector = orConditions[0];
      } else if (orConditions.length > 1) {
        selector = { $and: orConditions };
      }

      console.log('Filter selector:', JSON.stringify(selector, null, 2));

      const result = await pouchDB.find({
        selector: selector,
        limit: 1000
      });

      this.filteredData = result.docs.filter(doc => !doc._id.startsWith('_design/'));
      console.log('Filtered data:', this.filteredData.length, 'items');

    } catch (error) {
      console.error('Filter error:', error);
      // Fallback to simple text filtering if PouchDB find fails
      this.filteredData = this.kanbanData.filter(item => {
        const searchText = this.filterQuery.toLowerCase();
        return Object.values(item).some(value => 
          String(value || '').toLowerCase().includes(searchText)
        );
      });
    }
  },

  clearFilter() {
    this.filterQuery = '';
    this.filteredData = this.kanbanData;
  },
  
  getColumnData(column) {
    if (!this.filteredData.length || !column.filters) return [];
    
    return this.filteredData.filter(item => {
      return column.filters.every(filter => {
        const fieldValue = item[filter.field];
        const filterValue = filter.value;
        
        switch (filter.operator) {
          case 'equals':
            return fieldValue == filterValue;
          case 'not_equals':
            return fieldValue != filterValue;
          case 'contains':
            return String(fieldValue || '').toLowerCase().includes(String(filterValue || '').toLowerCase());
          case 'not_contains':
            return !String(fieldValue || '').toLowerCase().includes(String(filterValue || '').toLowerCase());
          case 'starts_with':
            return String(fieldValue || '').toLowerCase().startsWith(String(filterValue || '').toLowerCase());
          case 'ends_with':
            return String(fieldValue || '').toLowerCase().endsWith(String(filterValue || '').toLowerCase());
          case 'exists':
            return fieldValue !== undefined && fieldValue !== null && fieldValue !== '';
          case 'not_exists':
            return fieldValue === undefined || fieldValue === null || fieldValue === '';
          case 'empty':
            return !fieldValue || fieldValue === '';
          case 'not_empty':
            return fieldValue && fieldValue !== '';
          default:
            return true;
        }
      });
    });
  },
  
  formatFieldValue(value, type) {
    if (!value) return '';
    
    switch (type) {
      case 'date':
        return new Date(value).toLocaleDateString();
      case 'number':
        return Number(value).toLocaleString();
      case 'badge':
        return value;
      default:
        return String(value);
    }
  },
  
  replaceUrlTokens(url, item) {
    if (!url || !item) return url;
    return url.replace(/\$\{([^}]+)\}/g, (match, field) => {
      return encodeURIComponent(item[field] || '');
    });
  }
}" x-init="loadKanbanData()">

  <!-- Filter Search Bar -->
  <div x-show="card.config.dataSource && !loading" class="mb-3">
    <div class="relative">
      <input 
        type="text" 
        x-model="filterQuery"
        @input="performFilter()"
        @keyup.enter="performFilter()"
        class="w-full bg-gray-700 text-white px-4 py-2 pl-10 pr-20 rounded-lg border border-gray-600 focus:outline-none focus:border-blue-500 text-sm"
        placeholder="Filter kanban items..."
      >
      <svg class="absolute left-3 top-2.5 h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
      <button 
        x-show="filterQuery"
        @click="clearFilter()"
        class="absolute right-2 top-1.5 bg-gray-600 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs"
      >
        Clear
      </button>
    </div>
  </div>

  <!-- Sync Button -->
  <div x-show="card.config.dataSource" class="flex justify-end items-center gap-2 mb-3">
    <span class="text-xs text-gray-400">
      <span x-show="!filterQuery" x-text="kanbanData.length"></span>
      <span x-show="filterQuery" x-text="filteredData.length + ' of ' + kanbanData.length"></span> items
    </span>
    <button @click="
      console.log('Syncing kanban data source:', card.config.dataSource);
      loading = true;
      const formId = card.config.dataSource.split('/').pop();
      syncPouchDB(formId).then(() => {
        console.log('Sync completed, reloading kanban data...');
        return loadKanbanData();
      }).catch(error => {
        console.error('Sync failed:', error);
        loading = false;
      });
    " 
            class="bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded text-xs flex items-center gap-1"
            title="Synchronize kanban data"
            :disabled="loading">
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
      </svg>
      Sync
    </button>
  </div>
  
  <!-- No Data Source -->
  <div x-show="!card.config.dataSource" class="bg-gray-700 p-4 rounded h-32 flex items-center justify-center">
    <span class="text-gray-400 text-sm">Select a data source to configure kanban board</span>
  </div>
  
  <!-- Loading -->
  <div x-show="loading && card.config.dataSource" class="bg-gray-700 p-4 rounded h-32 flex items-center justify-center">
    <span class="text-gray-400 text-sm">Loading kanban data...</span>
  </div>
  
  <!-- Kanban Board -->
  <div x-show="card.config.dataSource && !loading" class="flex space-x-3 h-96 overflow-x-auto">
    <template x-for="column in card.config.columns || []">
      <div class="bg-gray-700 rounded p-3 min-w-64 max-w-80 flex-shrink-0">
        <!-- Column Header -->
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-sm font-medium text-white" x-text="column.title"></h4>
          <span class="text-xs text-gray-400 bg-gray-600 px-2 py-1 rounded" 
                x-text="getColumnData(column).length"></span>
        </div>
        
        <!-- Column Cards -->
        <div class="space-y-2 max-h-80 overflow-y-auto">
          <template x-for="item in getColumnData(column)" :key="item.id || Math.random()">
            <div class="bg-gray-600 p-3 rounded border border-gray-500 hover:border-gray-400 transition-colors">
              <!-- Display Fields -->
              <template x-for="displayField in column.displayFields || []" :key="displayField.field">
                <div class="mb-2">
                  <div x-show="displayField.label" 
                       class="text-xs text-gray-400 mb-1" 
                       x-text="displayField.label"></div>
                  <div class="text-sm text-white">
                    <span x-show="displayField.type === 'badge'" 
                          class="inline-block bg-blue-600 text-white px-2 py-1 rounded text-xs"
                          x-text="formatFieldValue(item[displayField.field], displayField.type)"></span>
                    <span x-show="displayField.type !== 'badge'" 
                          x-text="formatFieldValue(item[displayField.field], displayField.type)"></span>
                  </div>
                </div>
              </template>
              
              <!-- Card Actions -->
              <div x-show="column.actions && column.actions.length > 0" class="mt-3 pt-2 border-t border-gray-500">
                <div class="flex flex-wrap gap-1">
                  <template x-for="action in column.actions || []" :key="action.label">
                    <a :href="replaceUrlTokens(action.url, item)"
                       :target="action.openInNewWindow ? '_blank' : '_self'"
                       class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs transition-colors"
                       x-text="action.label"></a>
                  </template>
                </div>
              </div>
            </div>
          </template>
          
          <!-- Empty State -->
          <div x-show="getColumnData(column).length === 0" 
               class="text-center text-gray-400 text-xs py-4">
            No items in this column
          </div>
        </div>
      </div>
    </template>
    
    <!-- No Columns -->
    <div x-show="!card.config.columns || card.config.columns.length === 0" 
         class="bg-gray-700 p-4 rounded h-32 flex items-center justify-center w-full">
      <span class="text-gray-400 text-sm">Configure columns to display kanban board</span>
    </div>
  </div>
</div>
