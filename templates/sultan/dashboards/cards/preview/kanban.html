
<div class="bg-gray-800 p-4 rounded-lg h-full" x-data="{
  kanbanData: [],
  loading: false,
  
  async loadKanbanData() {
    if (!card.config.dataSource) return;
    
    this.loading = true;
    try {
      // Extract form ID from data source URL
      let formId = null;
      let isDrafts = false;
      
      if (card.config.dataSource.startsWith('/pc-analytics-jaffar/forms/api/pouchdb/init/')) {
        formId = card.config.dataSource.split('/').pop();
      } else if (card.config.dataSource.includes('forms/')) {
        const parts = card.config.dataSource.split('/');
        const formsIndex = parts.indexOf('forms');
        if (formsIndex >= 0 && formsIndex < parts.length - 1) {
          formId = parts[formsIndex + 1];
        }
      }
      
      if (!formId) {
        console.error('Could not extract form ID from data source:', card.config.dataSource);
        return;
      }
      
      // Check if it's a drafts database
      isDrafts = formId.endsWith('_drafts');
      const cleanFormId = isDrafts ? formId.replace('_drafts', '') : formId;
      
      console.log('Loading kanban data from PouchDB for form:', cleanFormId, 'isDrafts:', isDrafts);
      
      // Initialize PouchDB for the form
      await initializePouchDB(formId);
      const pouchDB = new PouchDB(formId);
      
      // Get all documents from PouchDB
      const result = await pouchDB.allDocs({ include_docs: true });
      this.kanbanData = result.rows.map(row => row.doc).filter(doc => !doc._id.startsWith('_design/'));
      
      console.log('Loaded kanban data:', this.kanbanData.length, 'items');
    } catch (error) {
      console.error('Error loading kanban data:', error);
      this.kanbanData = [];
    } finally {
      this.loading = false;
    }
  },
  
  getColumnData(column) {
    if (!this.kanbanData.length || !column.filters) return [];
    
    return this.kanbanData.filter(item => {
      return column.filters.every(filter => {
        const fieldValue = item[filter.field];
        const filterValue = filter.value;
        
        switch (filter.operator) {
          case 'equals':
            return fieldValue == filterValue;
          case 'not_equals':
            return fieldValue != filterValue;
          case 'contains':
            return String(fieldValue || '').toLowerCase().includes(String(filterValue || '').toLowerCase());
          case 'not_contains':
            return !String(fieldValue || '').toLowerCase().includes(String(filterValue || '').toLowerCase());
          case 'starts_with':
            return String(fieldValue || '').toLowerCase().startsWith(String(filterValue || '').toLowerCase());
          case 'ends_with':
            return String(fieldValue || '').toLowerCase().endsWith(String(filterValue || '').toLowerCase());
          case 'exists':
            return fieldValue !== undefined && fieldValue !== null && fieldValue !== '';
          case 'not_exists':
            return fieldValue === undefined || fieldValue === null || fieldValue === '';
          case 'empty':
            return !fieldValue || fieldValue === '';
          case 'not_empty':
            return fieldValue && fieldValue !== '';
          default:
            return true;
        }
      });
    });
  },
  
  formatFieldValue(value, type) {
    if (!value) return '';
    
    switch (type) {
      case 'date':
        return new Date(value).toLocaleDateString();
      case 'number':
        return Number(value).toLocaleString();
      case 'badge':
        return value;
      default:
        return String(value);
    }
  },
  
  replaceUrlTokens(url, item) {
    if (!url || !item) return url;
    return url.replace(/\$\{([^}]+)\}/g, (match, field) => {
      return encodeURIComponent(item[field] || '');
    });
  }
}" x-init="loadKanbanData()">

  <div class="flex justify-between items-center mb-3">
    <h3 class="text-white font-semibold" x-text="card.config.title || 'Kanban Board'"></h3>
    
    <!-- Sync Button -->
    <div x-show="card.config.dataSource" class="flex items-center gap-2">
      <span class="text-xs text-gray-400">
        <span x-text="kanbanData.length"></span> items
      </span>
      <button @click="
        console.log('Syncing kanban data source:', card.config.dataSource);
        loading = true;
        const formId = card.config.dataSource.split('/').pop();
        syncPouchDB(formId).then(() => {
          console.log('Sync completed, reloading kanban data...');
          return loadKanbanData();
        }).catch(error => {
          console.error('Sync failed:', error);
          loading = false;
        });
      " 
              class="bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded text-xs flex items-center gap-1"
              title="Synchronize kanban data"
              :disabled="loading">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        Sync
      </button>
    </div>
  </div>
  
  <!-- No Data Source -->
  <div x-show="!card.config.dataSource" class="bg-gray-700 p-4 rounded h-32 flex items-center justify-center">
    <span class="text-gray-400 text-sm">Select a data source to configure kanban board</span>
  </div>
  
  <!-- Loading -->
  <div x-show="loading && card.config.dataSource" class="bg-gray-700 p-4 rounded h-32 flex items-center justify-center">
    <span class="text-gray-400 text-sm">Loading kanban data...</span>
  </div>
  
  <!-- Kanban Board -->
  <div x-show="card.config.dataSource && !loading" class="grid gap-3 h-96 overflow-x-auto" :style="`grid-template-columns: repeat(${(card.config.columns || []).length}, 1fr)`">
    <template x-for="column in card.config.columns || []">
      <div class="bg-gray-700 rounded p-3 min-w-0"></div>
        <!-- Column Header -->
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-sm font-medium text-white" x-text="column.title"></h4>
          <span class="text-xs text-gray-400 bg-gray-600 px-2 py-1 rounded" 
                x-text="getColumnData(column).length"></span>
        </div>
        
        <!-- Column Cards -->
        <div class="space-y-2 max-h-80 overflow-y-auto">
          <template x-for="item in getColumnData(column)" :key="item.id || Math.random()">
            <div class="bg-gray-600 p-3 rounded border border-gray-500 hover:border-gray-400 transition-colors">
              <!-- Display Fields -->
              <template x-for="displayField in column.displayFields || []" :key="displayField.field">
                <div class="mb-2">
                  <div x-show="displayField.label" 
                       class="text-xs text-gray-400 mb-1" 
                       x-text="displayField.label"></div>
                  <div class="text-sm text-white">
                    <span x-show="displayField.type === 'badge'" 
                          class="inline-block bg-blue-600 text-white px-2 py-1 rounded text-xs"
                          x-text="formatFieldValue(item[displayField.field], displayField.type)"></span>
                    <span x-show="displayField.type !== 'badge'" 
                          x-text="formatFieldValue(item[displayField.field], displayField.type)"></span>
                  </div>
                </div>
              </template>
              
              <!-- Card Actions -->
              <div x-show="column.actions && column.actions.length > 0" class="mt-3 pt-2 border-t border-gray-500">
                <div class="flex flex-wrap gap-1">
                  <template x-for="action in column.actions || []" :key="action.label">
                    <a :href="replaceUrlTokens(action.url, item)"
                       :target="action.openInNewWindow ? '_blank' : '_self'"
                       class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs transition-colors"
                       x-text="action.label"></a>
                  </template>
                </div>
              </div>
            </div>
          </template>
          
          <!-- Empty State -->
          <div x-show="getColumnData(column).length === 0" 
               class="text-center text-gray-400 text-xs py-4">
            No items in this column
          </div>
        </div>
      </div>
    </template>
    
    <!-- No Columns -->
    <div x-show="!card.config.columns || card.config.columns.length === 0" 
         class="bg-gray-700 p-4 rounded h-32 flex items-center justify-center w-full">
      <span class="text-gray-400 text-sm">Configure columns to display kanban board</span>
    </div>
  </div>
</div>
