
<div class="bg-gray-800 p-4 rounded-lg h-full"
     :style="{
       minHeight: card.size.height === 1 ? '200px' : 
                 card.size.height === 2 ? '300px' : 
                 card.size.height === 3 ? '400px' : 
                 card.size.height === 4 ? '500px' : '600px'
     }"
     x-data="{
  kanbanData: [],
  loading: false,
  showFilters: false,
  filterQuery: {},
  
  async loadKanbanData() {
    if (!card.config.dataSource) return;
    
    this.loading = true;
    try {
      // Extract form ID from data source URL
      let formId = null;
      let isDrafts = false;
      
      if (card.config.dataSource.startsWith('/pc-analytics-jaffar/forms/api/pouchdb/init/')) {
        formId = card.config.dataSource.split('/').pop();
      } else if (card.config.dataSource.includes('forms/')) {
        const parts = card.config.dataSource.split('/');
        const formsIndex = parts.indexOf('forms');
        if (formsIndex >= 0 && formsIndex < parts.length - 1) {
          formId = parts[formsIndex + 1];
        }
      }
      
      if (!formId) {
        console.error('Could not extract form ID from data source:', card.config.dataSource);
        return;
      }
      
      // Check if it's a drafts database
      isDrafts = formId.endsWith('_drafts');
      const cleanFormId = isDrafts ? formId.replace('_drafts', '') : formId;
      
      console.log('Loading kanban data from PouchDB for form:', cleanFormId, 'isDrafts:', isDrafts);
      
      // Initialize PouchDB for the form
      await initializePouchDB(formId);
      const pouchDB = new PouchDB(formId);
      
      // Build selector for PouchDB find
      let selector = { "_id": { "$gt": null } };
      
      // Apply global filters if any
      if (card.config.globalFilters && card.config.globalFilters.length > 0) {
        card.config.globalFilters.forEach(filter => {
          if (filter.field && filter.value && filter.operator) {
            switch (filter.operator) {
              case 'equals':
                selector[filter.field] = filter.value;
                break;
              case 'not_equals':
                selector[filter.field] = { "$ne": filter.value };
                break;
              case 'contains':
                selector[filter.field] = { "$regex": new RegExp(filter.value, "i") };
                break;
              case 'not_contains':
                selector[filter.field] = { "$not": { "$regex": new RegExp(filter.value, "i") } };
                break;
              case 'greater_than':
                selector[filter.field] = { "$gt": parseFloat(filter.value) || filter.value };
                break;
              case 'less_than':
                selector[filter.field] = { "$lt": parseFloat(filter.value) || filter.value };
                break;
              case 'exists':
                selector[filter.field] = { "$exists": true };
                break;
              case 'not_exists':
                selector[filter.field] = { "$exists": false };
                break;
            }
          }
        });
      }
      
      console.log('Using PouchDB find selector:', JSON.stringify(selector, null, 2));
      
      // Use PouchDB find instead of allDocs
      let result;
      try {
        result = await pouchDB.find({
          selector: selector,
          limit: 1000 // Reasonable limit
        });
        this.kanbanData = result.docs.filter(doc => !doc._id.startsWith('_design/'));
        console.log('Loaded kanban data using find:', this.kanbanData.length, 'items');
      } catch (findError) {
        console.log('PouchDB find failed, falling back to allDocs:', findError);
        // Fallback to allDocs if find fails
        result = await pouchDB.allDocs({ include_docs: true });
        this.kanbanData = result.rows.map(row => row.doc).filter(doc => !doc._id.startsWith('_design/'));
        console.log('Loaded kanban data using allDocs fallback:', this.kanbanData.length, 'items');
      }
      
      console.log('Loaded kanban data:', this.kanbanData.length, 'items');
    } catch (error) {
      console.error('Error loading kanban data:', error);
      this.kanbanData = [];
    } finally {
      this.loading = false;
    }
  },
  
  getColumnData(column) {
    if (!this.kanbanData.length || !column.filters) return [];
    
    return this.kanbanData.filter(item => {
      return column.filters.every(filter => {
        const fieldValue = item[filter.field];
        const filterValue = filter.value;
        
        switch (filter.operator) {
          case 'equals':
            return fieldValue == filterValue;
          case 'not_equals':
            return fieldValue != filterValue;
          case 'contains':
            return String(fieldValue || '').toLowerCase().includes(String(filterValue || '').toLowerCase());
          case 'not_contains':
            return !String(fieldValue || '').toLowerCase().includes(String(filterValue || '').toLowerCase());
          case 'starts_with':
            return String(fieldValue || '').toLowerCase().startsWith(String(filterValue || '').toLowerCase());
          case 'ends_with':
            return String(fieldValue || '').toLowerCase().endsWith(String(filterValue || '').toLowerCase());
          case 'exists':
            return fieldValue !== undefined && fieldValue !== null && fieldValue !== '';
          case 'not_exists':
            return fieldValue === undefined || fieldValue === null || fieldValue === '';
          case 'empty':
            return !fieldValue || fieldValue === '';
          case 'not_empty':
            return fieldValue && fieldValue !== '';
          default:
            return true;
        }
      });
    });
  },
  
  formatFieldValue(value, type) {
    if (!value) return '';
    
    switch (type) {
      case 'date':
        return new Date(value).toLocaleDateString();
      case 'number':
        return Number(value).toLocaleString();
      case 'badge':
        return value;
      default:
        return String(value);
    }
  },
  
  replaceUrlTokens(url, item) {
    if (!url || !item) return url;
    return url.replace(/\$\{([^}]+)\}/g, (match, field) => {
      return encodeURIComponent(item[field] || '');
    });
  }
}" x-init="loadKanbanData()">

  <!-- Filter and Sync Controls -->
  <div x-show="card.config.dataSource" class="flex justify-between items-center gap-2 mb-3">
    <!-- Filter Toggle -->
    <button @click="showFilters = !showFilters" 
            class="bg-gray-600 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs flex items-center gap-1"
            title="Toggle filters">
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"/>
      </svg>
      Filters
    </button>
    
    <!-- Right side controls -->
    <div class="flex items-center gap-2">
    <span class="text-xs text-gray-400">
      <span x-text="kanbanData.length"></span> items
    </span>
    <button @click="
      console.log('Syncing kanban data source:', card.config.dataSource);
      loading = true;
      const formId = card.config.dataSource.split('/').pop();
      syncPouchDB(formId).then(() => {
        console.log('Sync completed, reloading kanban data...');
        return loadKanbanData();
      }).catch(error => {
        console.error('Sync failed:', error);
        loading = false;
      });
    " 
            class="bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded text-xs flex items-center gap-1"
            title="Synchronize kanban data"
            :disabled="loading">
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
      </svg>
      Sync
    </button>
    </div>
  </div>
  
  <!-- Global Filters Panel -->
  <div x-show="showFilters && card.config.dataSource" 
       x-transition
       class="bg-gray-700 p-3 rounded mb-3 border border-gray-600">
    <div class="flex justify-between items-center mb-3">
      <h4 class="text-sm font-medium text-white">Global Filters</h4>
      <button @click="
        card.config.globalFilters = [];
        loadKanbanData();
      " class="text-xs text-red-400 hover:text-red-300">
        Clear All
      </button>
    </div>
    
    <!-- Add Filter Button -->
    <button @click="
      if (!card.config.globalFilters) card.config.globalFilters = [];
      card.config.globalFilters.push({
        field: '',
        operator: 'equals',
        value: ''
      });
    " class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs mb-3">
      + Add Filter
    </button>
    
    <!-- Filter List -->
    <div x-show="card.config.globalFilters && card.config.globalFilters.length > 0" class="space-y-2">
      <template x-for="(filter, index) in card.config.globalFilters || []" :key="index">
        <div class="flex items-center gap-2 bg-gray-600 p-2 rounded">
          <!-- Field Input -->
          <input type="text" 
                 x-model="filter.field"
                 placeholder="Field name"
                 class="flex-1 bg-gray-800 text-white px-2 py-1 rounded text-xs border border-gray-500 focus:border-blue-500">
          
          <!-- Operator Select -->
          <select x-model="filter.operator" 
                  class="bg-gray-800 text-white px-2 py-1 rounded text-xs border border-gray-500 focus:border-blue-500">
            <option value="equals">Equals</option>
            <option value="not_equals">Not Equals</option>
            <option value="contains">Contains</option>
            <option value="not_contains">Not Contains</option>
            <option value="greater_than">Greater Than</option>
            <option value="less_than">Less Than</option>
            <option value="exists">Field Exists</option>
            <option value="not_exists">Field Not Exists</option>
          </select>
          
          <!-- Value Input -->
          <input type="text" 
                 x-model="filter.value"
                 placeholder="Value"
                 x-show="!['exists', 'not_exists'].includes(filter.operator)"
                 class="flex-1 bg-gray-800 text-white px-2 py-1 rounded text-xs border border-gray-500 focus:border-blue-500">
          
          <!-- Apply Filter Button -->
          <button @click="loadKanbanData()" 
                  class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs">
            Apply
          </button>
          
          <!-- Remove Filter Button -->
          <button @click="
            card.config.globalFilters.splice(index, 1);
            loadKanbanData();
          " class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">
            Ã—
          </button>
        </div>
      </template>
    </div>
    
    <!-- No Filters Message -->
    <div x-show="!card.config.globalFilters || card.config.globalFilters.length === 0" 
         class="text-gray-400 text-xs text-center py-2">
      No filters configured. Click "Add Filter" to create one.
    </div>
  </div>
  
  <!-- No Data Source -->
  <div x-show="!card.config.dataSource" class="bg-gray-700 p-4 rounded h-32 flex items-center justify-center">
    <span class="text-gray-400 text-sm">Select a data source to configure kanban board</span>
  </div>
  
  <!-- Loading -->
  <div x-show="loading && card.config.dataSource" class="bg-gray-700 p-4 rounded h-32 flex items-center justify-center">
    <span class="text-gray-400 text-sm">Loading kanban data...</span>
  </div>
  
  <!-- Kanban Board -->
  <div x-show="card.config.dataSource && !loading" class="flex space-x-3 h-96 overflow-x-auto">
    <template x-for="column in card.config.columns || []">
      <div class="bg-gray-700 rounded p-3 min-w-64 max-w-80 flex-shrink-0">
        <!-- Column Header -->
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-sm font-medium text-white" x-text="column.title"></h4>
          <span class="text-xs text-gray-400 bg-gray-600 px-2 py-1 rounded" 
                x-text="getColumnData(column).length"></span>
        </div>
        
        <!-- Column Cards -->
        <div class="space-y-2 max-h-80 overflow-y-auto">
          <template x-for="item in getColumnData(column)" :key="item.id || Math.random()">
            <div class="bg-gray-600 p-3 rounded border border-gray-500 hover:border-gray-400 transition-colors">
              <!-- Display Fields -->
              <template x-for="displayField in column.displayFields || []" :key="displayField.field">
                <div class="mb-2">
                  <div x-show="displayField.label" 
                       class="text-xs text-gray-400 mb-1" 
                       x-text="displayField.label"></div>
                  <div class="text-sm text-white">
                    <span x-show="displayField.type === 'badge'" 
                          class="inline-block bg-blue-600 text-white px-2 py-1 rounded text-xs"
                          x-text="formatFieldValue(item[displayField.field], displayField.type)"></span>
                    <span x-show="displayField.type !== 'badge'" 
                          x-text="formatFieldValue(item[displayField.field], displayField.type)"></span>
                  </div>
                </div>
              </template>
              
              <!-- Card Actions -->
              <div x-show="column.actions && column.actions.length > 0" class="mt-3 pt-2 border-t border-gray-500">
                <div class="flex flex-wrap gap-1">
                  <template x-for="action in column.actions || []" :key="action.label">
                    <a :href="replaceUrlTokens(action.url, item)"
                       :target="action.openInNewWindow ? '_blank' : '_self'"
                       class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs transition-colors"
                       x-text="action.label"></a>
                  </template>
                </div>
              </div>
            </div>
          </template>
          
          <!-- Empty State -->
          <div x-show="getColumnData(column).length === 0" 
               class="text-center text-gray-400 text-xs py-4">
            No items in this column
          </div>
        </div>
      </div>
    </template>
    
    <!-- No Columns -->
    <div x-show="!card.config.columns || card.config.columns.length === 0" 
         class="bg-gray-700 p-4 rounded h-32 flex items-center justify-center w-full">
      <span class="text-gray-400 text-sm">Configure columns to display kanban board</span>
    </div>
  </div>
</div>
