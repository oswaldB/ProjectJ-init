
<!-- Sync Status Indicator Component -->
<div x-data="syncIndicator()" x-init="init()" class="fixed bottom-4 right-4 z-50">
  <!-- Main Sync Button -->
  <button 
    @click="toggleSyncPanel()" 
    class="bg-red-600 text-white p-3 rounded-full shadow-lg hover:bg-red-700 transition-all duration-200"
    :class="{ 'animate-pulse': hasActiveSyncs }"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
    </svg>
  </button>

  <!-- Sync Panel -->
  <div 
    x-show="showPanel" 
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 transform scale-95"
    x-transition:enter-end="opacity-100 transform scale-100"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100 transform scale-100"
    x-transition:leave-end="opacity-0 transform scale-95"
    class="absolute bottom-16 right-0 bg-gray-800 border border-gray-600 rounded-lg shadow-xl p-4 w-80"
  >
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-white font-semibold">Data Sync Status</h3>
      <button @click="showPanel = false" class="text-gray-400 hover:text-white">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Sync All Button -->
    <button 
      @click="syncAllSources()" 
      :disabled="hasActiveSyncs"
      class="w-full bg-red-600 text-white py-2 px-4 rounded mb-3 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <span x-show="!hasActiveSyncs">Sync All Sources</span>
      <span x-show="hasActiveSyncs">Syncing...</span>
    </button>

    <!-- Sources List -->
    <div class="space-y-2 max-h-60 overflow-y-auto">
      <template x-for="source in Object.keys(syncStatus)" :key="source">
        <div class="bg-gray-700 p-3 rounded">
          <div class="flex justify-between items-center mb-2">
            <span class="text-white font-medium" x-text="source"></span>
            <button 
              @click="syncSource(source)" 
              :disabled="syncStatus[source]?.status === 'syncing'"
              class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 disabled:opacity-50"
            >
              Sync
            </button>
          </div>
          
          <!-- Progress Bar -->
          <div x-show="syncStatus[source]?.status === 'syncing'" class="mb-2">
            <div class="bg-gray-600 rounded-full h-2">
              <div 
                class="bg-red-500 h-2 rounded-full transition-all duration-300"
                :style="`width: ${syncStatus[source]?.progress || 0}%`"
              ></div>
            </div>
            <div class="text-xs text-gray-300 mt-1" x-text="`${syncStatus[source]?.progress || 0}%`"></div>
          </div>
          
          <!-- Status -->
          <div class="flex items-center space-x-2">
            <div 
              class="w-2 h-2 rounded-full"
              :class="{
                'bg-yellow-500': syncStatus[source]?.status === 'pending',
                'bg-blue-500 animate-pulse': syncStatus[source]?.status === 'syncing',
                'bg-green-500': syncStatus[source]?.status === 'completed',
                'bg-red-500': syncStatus[source]?.status === 'error',
                'bg-gray-500': !syncStatus[source]?.status
              }"
            ></div>
            <span class="text-xs text-gray-300" x-text="syncStatus[source]?.message || 'Ready'"></span>
          </div>
        </div>
      </template>
    </div>
  </div>
</div>

<script>
function syncIndicator() {
  return {
    showPanel: false,
    syncStatus: {},
    sources: [],
    
    get hasActiveSyncs() {
      return Object.values(this.syncStatus).some(status => status?.status === 'syncing');
    },
    
    init() {
      // Initialize sync service if not already done
      if (window.sultanPouchDB) {
        // Listen for sync status updates
        window.sultanPouchDB.on('syncStatusUpdate', (data) => {
          this.syncStatus[data.sourceId] = data.status;
        });
        
        // Load initial sources and status
        this.loadSources();
      }
    },
    
    async loadSources() {
      try {
        if (window.sultanPouchDB) {
          this.sources = await window.sultanPouchDB.discoverDataSources();
          this.sources.forEach(source => {
            if (!this.syncStatus[source]) {
              this.syncStatus[source] = { status: 'ready', progress: 0, message: 'Ready to sync' };
            }
          });
        }
      } catch (error) {
        console.error('Failed to load sources:', error);
      }
    },
    
    toggleSyncPanel() {
      this.showPanel = !this.showPanel;
    },
    
    async syncSource(sourceId) {
      if (window.sultanPouchDB) {
        await window.sultanPouchDB.syncSource(sourceId);
      }
    },
    
    async syncAllSources() {
      if (window.sultanPouchDB) {
        await window.sultanPouchDB.syncAllSources();
      }
    }
  };
}
</script>
</div>
