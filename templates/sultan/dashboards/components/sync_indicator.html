
<!-- Sync Controls -->
<div x-data="syncControls()" class="mb-4 p-4 bg-gray-800 rounded-lg border border-gray-700">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-white font-semibold">Data Synchronization</h3>
        <div class="flex space-x-2">
            <button @click="syncAll()" 
                    :disabled="syncing"
                    class="bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white px-4 py-2 rounded text-sm">
                <span x-show="!syncing">Sync All</span>
                <span x-show="syncing">Syncing...</span>
            </button>
            <button @click="refreshStatuses()" 
                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm">
                Refresh
            </button>
        </div>
    </div>
    
    <!-- Data Source List -->
    <div class="space-y-2">
        <template x-for="source in dataSources" :key="source">
            <div class="flex items-center justify-between p-3 bg-gray-700 rounded border border-gray-600">
                <div class="flex items-center space-x-3">
                    <span class="text-white font-medium" x-text="source"></span>
                    <span class="text-xs px-2 py-1 rounded"
                          :class="{
                            'bg-green-600 text-white': getSyncStatus(source).status === 'completed',
                            'bg-red-600 text-white': getSyncStatus(source).status === 'error',
                            'bg-blue-600 text-white': getSyncStatus(source).status === 'syncing' || getSyncStatus(source).status === 'fetching',
                            'bg-yellow-600 text-black': getSyncStatus(source).status === 'starting' || getSyncStatus(source).status === 'clearing',
                            'bg-gray-600 text-white': getSyncStatus(source).status === 'idle'
                          }"
                          x-text="getSyncStatus(source).status || 'idle'"></span>
                </div>
                
                <div class="flex items-center space-x-3">
                    <!-- Progress Bar -->
                    <div x-show="getSyncStatus(source).total > 0" class="w-32">
                        <div class="bg-gray-600 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-300"
                                 :style="`width: ${getSyncStatus(source).total > 0 ? (getSyncStatus(source).progress / getSyncStatus(source).total) * 100 : 0}%`"></div>
                        </div>
                        <div class="text-xs text-gray-400 mt-1 text-center" 
                             x-text="`${getSyncStatus(source).progress || 0}/${getSyncStatus(source).total || 0}`"></div>
                    </div>
                    
                    <!-- Sync Button -->
                    <button @click="syncSource(source)" 
                            :disabled="getSyncStatus(source).status === 'syncing' || getSyncStatus(source).status === 'starting'"
                            class="bg-green-600 hover:bg-green-700 disabled:bg-green-400 text-white px-3 py-1 rounded text-sm">
                        <span x-show="getSyncStatus(source).status !== 'syncing' && getSyncStatus(source).status !== 'starting'">Sync</span>
                        <span x-show="getSyncStatus(source).status === 'syncing' || getSyncStatus(source).status === 'starting'">...</span>
                    </button>
                </div>
            </div>
        </template>
    </div>
    
    <!-- Error Messages -->
    <div x-show="errors.length > 0" class="mt-4">
        <h4 class="text-red-400 font-semibold mb-2">Sync Errors:</h4>
        <template x-for="error in errors" :key="error.source">
            <div class="bg-red-900 border border-red-600 rounded p-2 mb-2">
                <span class="text-red-200 font-medium" x-text="error.source"></span>
                <span class="text-red-300">: </span>
                <span class="text-red-100" x-text="error.message"></span>
            </div>
        </template>
    </div>
</div>

<script>
function syncControls() {
    return {
        dataSources: [],
        syncStatuses: {},
        syncing: false,
        errors: [],
        
        async init() {
            await this.discoverDataSources();
            this.setupProgressListener();
            
            // Refresh statuses periodically
            setInterval(() => {
                this.refreshStatuses();
            }, 2000);
        },
        
        async discoverDataSources() {
            if (window.pouchDBSyncService) {
                this.dataSources = await window.pouchDBSyncService.discoverDataSources();
            }
        },
        
        setupProgressListener() {
            window.addEventListener('pouchdb-sync-progress', (event) => {
                const { dbName, progress } = event.detail;
                this.syncStatuses[dbName] = progress;
                
                // Update errors
                if (progress.status === 'error') {
                    const existingError = this.errors.find(e => e.source === dbName);
                    if (!existingError) {
                        this.errors.push({ source: dbName, message: progress.error });
                    }
                } else {
                    this.errors = this.errors.filter(e => e.source !== dbName);
                }
            });
        },
        
        refreshStatuses() {
            if (window.getAllSyncStatuses) {
                this.syncStatuses = window.getAllSyncStatuses();
            }
        },
        
        getSyncStatus(source) {
            return this.syncStatuses[source] || { status: 'idle', progress: 0, total: 0, error: null };
        },
        
        async syncSource(source) {
            if (window.syncDataSource) {
                await window.syncDataSource(source);
            }
        },
        
        async syncAll() {
            if (window.syncAllDataSources) {
                this.syncing = true;
                this.errors = [];
                await window.syncAllDataSources();
                this.syncing = false;
            }
        }
    };
}
</script>
