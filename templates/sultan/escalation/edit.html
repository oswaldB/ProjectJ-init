{% extends "sultan/base.html" %}

{% block title %}Escalation Editor{% endblock %}

{% block alpine_component %}
{
  escalation: {
    blocks: [{
      form: '',
      triggers: [{
        issueFamily: '',
        comparisonKey: '',
        operator: '',
        value: '',
        when: '',
        template: ''
      }]
    }]
  },
  templates: [],
  issuesFamilies: ['Valuation', 'Data Quality', 'System', 'Process', 'People'],
  keys: [],
  async init() {
    await this.loadTemplates();
  },
  async loadTemplates() {
    try {
      const response = await fetch('/api/sultan/templates/list');
      this.templates = await response.json();
    } catch (error) {
      console.error('Failed to load templates:', error);
    }
  },
  exportToExcel() {
    let csvContent = 'Issue Family,Name,When,Trigger Key,Trigger Operator,Trigger Compare to,Action Type,Action to,Action template\n';
    this.escalation.blocks.forEach(block => {
      block.triggers.forEach(trigger => {
        const row = [
          trigger.issueFamily || '',
          block.name || '',
          trigger.when || '',
          trigger.comparisonKey || '',
          trigger.operator || '',
          trigger.value || '',
          trigger.actionType || '',
          (trigger.emailList || []).join(';') || '',
          trigger.template || ''
        ].map(cell => `"${cell}"`).join(',');
        csvContent += row + '\n';
      });
    });
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'escalation_rules.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  },
  async importExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result;
      const rows = text.split('\n');
      rows.shift();
      const newBlocks = [];
      let currentBlock = null;
      rows.forEach(row => {
        if (!row.trim()) return;
        const values = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)
          .map(val => val.replace(/^"|"$/g, '').trim());
        if (values.length >= 9) {
          const [issueFamily, name, when, triggerKey, operator, value, actionType, actionTo, template] = values;
          if (!currentBlock || currentBlock.name !== name) {
            currentBlock = {
              name: name,
              form: this.escalation.form,
              triggers: []
            };
            newBlocks.push(currentBlock);
          }
          currentBlock.triggers.push({
            issueFamily,
            when,
            comparisonKey: triggerKey,
            operator,
            value,
            actionType,
            emailList: actionTo.split(';').filter(e => e),
            template
          });
        }
      });
      if (newBlocks.length > 0) {
        this.escalation.blocks = newBlocks;
      }
    };
    reader.readAsText(file);
  }
}
{% endblock %}

{% block content %}
<div class="h-screen bg-gray-900 text-white p-4">
  <!-- Import/Export Buttons -->
  <div class="mb-4">
    <input type="file" @change="importExcel($event)" accept=".csv" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
    <button @click="exportToExcel()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 ml-2">
      Export to Excel
    </button>
  </div>

  <!-- Excel-like Grid -->
  <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
    <div class="grid grid-cols-9 gap-0 border border-gray-600">
      <!-- Headers -->
      <div class="bg-gray-700 p-2 border-b border-r border-gray-600 font-semibold">Issue Family</div>
      <div class="bg-gray-700 p-2 border-b border-r border-gray-600 font-semibold">Name</div>
      <div class="bg-gray-700 p-2 border-b border-r border-gray-600 font-semibold">When</div>
      <div class="bg-gray-700 p-2 border-b border-r border-gray-600 font-semibold">Trigger Key</div>
      <div class="bg-gray-700 p-2 border-b border-r border-gray-600 font-semibold">Trigger Operator</div>
      <div class="bg-gray-700 p-2 border-b border-r border-gray-600 font-semibold">Trigger Compare to</div>
      <div class="bg-gray-700 p-2 border-b border-r border-gray-600 font-semibold">Action Type</div>
      <div class="bg-gray-700 p-2 border-b border-r border-gray-600 font-semibold">Action to</div>
      <div class="bg-gray-700 p-2 border-b border-gray-600 font-semibold">Action template</div>

      <!-- Grid Rows -->
      <template x-for="(block, blockIndex) in escalation.blocks" :key="blockIndex">
        <template x-for="(trigger, triggerIndex) in block.triggers" :key="triggerIndex">
          <div class="contents">
            <div class="bg-gray-800 p-1 border-r border-gray-600">
              <select x-model="trigger.issueFamily" class="w-full bg-transparent text-white p-2 focus:bg-gray-700">
                <option value="">Select Issue Family</option>
                <template x-for="family in issuesFamilies">
                  <option :value="family" x-text="family"></option>
                </template>
              </select>
            </div>
            <div class="bg-gray-800 p-1 border-r border-gray-600">
              <input type="text" x-model="block.name" class="w-full bg-transparent text-white p-2 focus:bg-gray-700">
            </div>
            <div class="bg-gray-800 p-1 border-r border-gray-600">
              <select x-model="trigger.when" class="w-full bg-transparent text-white p-2 focus:bg-gray-700">
                <option value="">Select When</option>
                <option value="now">now</option>
                <option value="now+5">now+5</option>
                <option value="now+10">now+10</option>
                <option value="now+15">now+15</option>
                <option value="now+30">now+30</option>
                <option value="now+60">now+60</option>
              </select>
            </div>
            <div class="bg-gray-800 p-1 border-r border-gray-600">
              <select x-model="trigger.comparisonKey" class="w-full bg-transparent text-white p-2 focus:bg-gray-700">
                <option value="">Select Key</option>
                <template x-for="key in keys">
                  <option :value="key" x-text="key"></option>
                </template>
              </select>
            </div>
            <div class="bg-gray-800 p-1 border-r border-gray-600">
              <select x-model="trigger.operator" class="w-full bg-transparent text-white p-2 focus:bg-gray-700">
                <option value="">Select Operator</option>
                <option value="equals">Equals</option>
                <option value="bigger">Bigger</option>
                <option value="smaller">Smaller</option>
                <option value="contains">Contains</option>
              </select>
            </div>
            <div class="bg-gray-800 p-1 border-r border-gray-600">
              <input type="text" x-model="trigger.value" class="w-full bg-transparent text-white p-2 focus:bg-gray-700">
            </div>
            <div class="bg-gray-800 p-1 border-r border-gray-600">
              <select x-model="trigger.actionType" class="w-full bg-transparent text-white p-2 focus:bg-gray-700">
                <option value="">Select Action</option>
                <option value="email">Email</option>
                <option value="notification">Notification</option>
                <option value="webhook">Webhook</option>
              </select>
            </div>
            <div class="bg-gray-800 p-1 border-r border-gray-600">
              <input type="text" x-model="trigger.emailList" class="w-full bg-transparent text-white p-2 focus:bg-gray-700">
            </div>
            <div class="bg-gray-800 p-1 border-gray-600">
              <select x-model="trigger.template" class="w-full bg-transparent text-white p-2 focus:bg-gray-700">
                <option value="">Select Template</option>
                <template x-for="template in templates">
                  <option :value="template.id" x-text="template.name"></option>
                </template>
              </select>
            </div>
          </div>
        </template>
      </template>
    </div>
  </div>
</div>
{% endblock %}