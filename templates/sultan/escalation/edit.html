
{% extends "sultan/base.html" %}

{% block title %}Escalation Editor{% endblock %}

{% block alpine_component %}
  {
    page: 'escalation-editor',
    escalation: {
      id: '',
      name: '',
      template: '',
      form: '',
      rules: [],
      status: 'Draft'
    },
    templates: [],
    forms: [],
    newRule: {
      condition: '',
      action: '',
      target: ''
    },
    async init() {
      const escalationId = window.location.pathname.split('/').pop();
      if (escalationId !== 'new') {
        await this.loadEscalation(escalationId);
      }
      await this.loadTemplates();
      await this.loadForms();
    },
    async loadEscalation(id) {
      try {
        const response = await fetch(`/api/sultan/escalation/${id}`);
        this.escalation = await response.json();
      } catch (error) {
        console.error('Failed to load escalation:', error);
      }
    },
    async loadTemplates() {
      try {
        const response = await fetch('/api/sultan/templates/list');
        this.templates = await response.json();
      } catch (error) {
        console.error('Failed to load templates:', error);
      }
    },
    async loadForms() {
      try {
        const response = await fetch('/api/sultan/forms/list');
        this.forms = await response.json();
      } catch (error) {
        console.error('Failed to load forms:', error);
      }
    },
    addRule() {
      this.escalation.rules.push({ ...this.newRule });
      this.newRule = { condition: '', action: '', target: '' };
    },
    removeRule(index) {
      this.escalation.rules.splice(index, 1);
    },
    async save() {
      if (!this.escalation.id) {
        this.escalation.id = `escalation-${Date.now()}`;
      }
      try {
        await fetch('/api/sultan/escalation/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: localStorage.getItem('user_email'),
            escalation: this.escalation
          })
        });
        window.location.href = '/sultan/escalation';
      } catch (error) {
        console.error('Failed to save escalation:', error);
      }
    }
  }
{% endblock %}

{% block content %}
<div class="p-6">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-white">Escalation Editor</h1>
    <div class="space-x-4">
      <button @click="save()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Save</button>
    </div>
  </div>

  <div class="space-y-6">
    <div class="grid grid-cols-3 gap-4">
      <input 
        type="text" 
        x-model="escalation.name" 
        placeholder="Escalation Name"
        class="bg-gray-800 text-white px-4 py-2 rounded-lg border border-gray-600 focus:outline-none focus:border-red-500"
      >
      
      <select 
        x-model="escalation.template"
        class="bg-gray-800 text-white px-4 py-2 rounded-lg border border-gray-600 focus:outline-none focus:border-red-500"
      >
        <option value="">Select Template</option>
        <template x-for="template in templates" :key="template.id">
          <option :value="template.id" x-text="template.name"></option>
        </template>
      </select>

      <select 
        x-model="escalation.form"
        class="bg-gray-800 text-white px-4 py-2 rounded-lg border border-gray-600 focus:outline-none focus:border-red-500"
      >
        <option value="">Select Form</option>
        <template x-for="form in forms" :key="form.id">
          <option :value="form.id" x-text="form.name"></option>
        </template>
      </select>
    </div>

    <!-- Excel-like Rules Table -->
    <div class="overflow-x-auto bg-gray-800 rounded-lg p-4">
      <table class="w-full text-white">
        <thead>
          <tr class="border-b border-gray-600">
            <th class="px-4 py-2 text-left">Condition</th>
            <th class="px-4 py-2 text-left">Action</th>
            <th class="px-4 py-2 text-left">Target</th>
            <th class="px-4 py-2 text-left">Actions</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(rule, index) in escalation.rules" :key="index">
            <tr class="border-b border-gray-700">
              <td class="px-4 py-2">
                <input 
                  type="text" 
                  x-model="rule.condition"
                  class="w-full bg-transparent border-none focus:outline-none"
                >
              </td>
              <td class="px-4 py-2">
                <input 
                  type="text" 
                  x-model="rule.action"
                  class="w-full bg-transparent border-none focus:outline-none"
                >
              </td>
              <td class="px-4 py-2">
                <input 
                  type="text" 
                  x-model="rule.target"
                  class="w-full bg-transparent border-none focus:outline-none"
                >
              </td>
              <td class="px-4 py-2">
                <button @click="removeRule(index)" class="text-red-400 hover:text-red-300">Remove</button>
              </td>
            </tr>
          </template>
          <tr>
            <td class="px-4 py-2">
              <input 
                type="text" 
                x-model="newRule.condition"
                placeholder="Enter condition"
                class="w-full bg-transparent border-none focus:outline-none"
              >
            </td>
            <td class="px-4 py-2">
              <input 
                type="text" 
                x-model="newRule.action"
                placeholder="Enter action"
                class="w-full bg-transparent border-none focus:outline-none"
              >
            </td>
            <td class="px-4 py-2">
              <input 
                type="text" 
                x-model="newRule.target"
                placeholder="Enter target"
                class="w-full bg-transparent border-none focus:outline-none"
              >
            </td>
            <td class="px-4 py-2">
              <button @click="addRule()" class="text-green-400 hover:text-green-300">Add Rule</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
