
{% extends 'base.html' %}

{% block content %}
<div class="p-4 ml-[260px]" x-data="{
  form: {
    id: new URLSearchParams(window.location.search).get('id') || ('form-' + Date.now()),
    fields: []
  },
  templates: {
    single_select: { type: 'single_select', name: '', key: '', description: '', required: true, options: [], order: 0 },
    text_input: { type: 'text_input', name: '', key: '', description: '', required: true, order: 0 },
    textarea: { type: 'textarea', name: '', key: '', description: '', required: true, order: 0 },
    multiple_checkbox: { type: 'multiple_checkbox', name: '', key: '', description: '', required: true, options: [], order: 0 },
    date: { type: 'date', name: '', key: '', description: '', required: true, order: 0 },
    conditionnal: { type: 'conditionnal', name: '', key: '', description: '', required: true, options: [], optionsCond: [], order: 0 },
    list: { type: 'list', name: '', key: '', description: '', required: true, options: [], optionsCond: [], order: 0 },
    composite: { type: 'composite', name: '', key: '', description: '', required: true, options: [], order: 0 }
  },
  addField() {
    this.form.fields.push({...this.templates.text_input});
  },
  addOption(field) {
    field.options = field.options || [];
    field.options.push({name: ''});
  },
  addCondition(field) {
    field.optionsCond = field.optionsCond || [];
    field.optionsCond.push({
      show: '',
      type: 'text_input',
      name: '',
      key: '',
      required: true,
      template: 'text_input'
    });
  },
  async saveForm() {
    const email = localStorage.getItem('email');
    await fetch('/api/sultan/forms/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: email,
        form: this.form
      })
    });
  }
}" x-init="
  $watch('form', value => localStorage.setItem('currentForm', JSON.stringify(value)), { deep: true });
  const email = localStorage.getItem('email');
  if(form.id) {
    fetch(`/api/sultan/forms/${form.id}?email=${email}`)
      .then(r => r.json())
      .then(data => form = data);
  }
">

  <div class="flex justify-between mb-4">
    <h1 class="text-2xl text-white">Form Editor</h1>
    <div class="space-x-2">
      <button @click="saveForm" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-500">Save</button>
      <a href="/sultan/forms/list" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-500">Back to List</a>
    </div>
  </div>

  <div class="grid grid-cols-2 gap-6">
    <!-- Form Editor -->
    <div class="bg-gray-800 p-4 rounded-lg space-y-4">
      <div class="flex justify-between mb-4">
        <button @click="addField" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-500">Add Field</button>
      </div>

      <template x-for="(field, index) in form.fields" :key="index">
        <div class="bg-gray-700 p-4 rounded-lg space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300">Type</label>
              <select x-model="field.type" @change="field = {...templates[field.type], ...{name: field.name, key: field.key}}" class="mt-1 w-full rounded-lg border border-gray-600 bg-gray-800 text-white px-4 py-2">
                <option value="text_input">Text Input</option>
                <option value="textarea">Text Area</option>
                <option value="single_select">Single Select</option>
                <option value="multiple_checkbox">Multiple Checkbox</option>
                <option value="date">Date</option>
                <option value="conditionnal">Conditional</option>
                <option value="list">List</option>
                <option value="composite">Composite</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300">Required</label>
              <input type="checkbox" x-model="field.required" class="mt-3">
            </div>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-300">Name</label>
              <input type="text" x-model="field.name" class="mt-1 w-full rounded-lg border border-gray-600 bg-gray-800 text-white px-4 py-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300">Key</label>
              <input type="text" x-model="field.key" class="mt-1 w-full rounded-lg border border-gray-600 bg-gray-800 text-white px-4 py-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300">Description</label>
              <textarea x-model="field.description" class="mt-1 w-full rounded-lg border border-gray-600 bg-gray-800 text-white px-4 py-2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300">Order</label>
              <input type="number" x-model="field.order" class="mt-1 w-full rounded-lg border border-gray-600 bg-gray-800 text-white px-4 py-2">
            </div>

            <!-- Options for select/checkbox types -->
            <template x-if="['single_select', 'multiple_checkbox', 'conditionnal', 'list', 'composite'].includes(field.type)">
              <div>
                <div class="flex justify-between items-center mb-2">
                  <label class="block text-sm font-medium text-gray-300">Options</label>
                  <button @click="addOption(field)" class="text-sm bg-blue-600 text-white px-2 py-1 rounded">Add Option</button>
                </div>
                <template x-for="(option, optIndex) in field.options" :key="optIndex">
                  <div class="flex gap-2 mt-2">
                    <input type="text" x-model="option.name" placeholder="Option name" class="flex-1 rounded-lg border border-gray-600 bg-gray-800 text-white px-4 py-2">
                    <button @click="field.options.splice(optIndex, 1)" class="text-red-400 hover:text-red-300">Remove</button>
                  </div>
                </template>
              </div>
            </template>

            <!-- Conditional logic -->
            <template x-if="['conditionnal', 'list'].includes(field.type)">
              <div>
                <div class="flex justify-between items-center mb-2">
                  <label class="block text-sm font-medium text-gray-300">Conditional Fields</label>
                  <button @click="addCondition(field)" class="text-sm bg-blue-600 text-white px-2 py-1 rounded">Add Condition</button>
                </div>
                <template x-for="(cond, condIndex) in field.optionsCond" :key="condIndex">
                  <div class="bg-gray-600 p-3 rounded mt-2 space-y-2">
                    <div class="flex gap-2">
                      <input type="text" x-model="cond.show" placeholder="Show when" class="flex-1 rounded-lg border border-gray-600 bg-gray-800 text-white px-4 py-2">
                      <select x-model="cond.type" class="rounded-lg border border-gray-600 bg-gray-800 text-white px-4 py-2">
                        <option value="text_input">Text Input</option>
                        <option value="textarea">Text Area</option>
                      </select>
                      <button @click="field.optionsCond.splice(condIndex, 1)" class="text-red-400 hover:text-red-300">Remove</button>
                    </div>
                    <input type="text" x-model="cond.name" placeholder="Field name" class="w-full rounded-lg border border-gray-600 bg-gray-800 text-white px-4 py-2">
                    <input type="text" x-model="cond.key" placeholder="Field key" class="w-full rounded-lg border border-gray-600 bg-gray-800 text-white px-4 py-2">
                  </div>
                </template>
              </div>
            </template>

            <button @click="form.fields.splice(index, 1)" class="text-red-400 hover:text-red-300">Remove Field</button>
          </div>
        </div>
      </template>
    </div>

    <!-- Live Preview -->
    <div class="bg-gray-800 p-4 rounded-lg space-y-4">
      <h2 class="text-xl text-white mb-4">Preview</h2>
      <template x-for="field in form.fields.sort((a, b) => a.order - b.order)" :key="field.key">
        <div class="mb-6">
          <label :class="{'text-red-500': field.required}" class="block text-lg font-medium text-white" x-text="field.name"></label>
          <p class="text-gray-400 text-sm mb-2" x-text="field.description"></p>

          <template x-if="field.type === 'text_input'">
            <input type="text" class="w-full rounded-lg border border-gray-600 bg-gray-900 text-white px-4 py-2">
          </template>

          <template x-if="field.type === 'textarea'">
            <textarea class="w-full rounded-lg border border-gray-600 bg-gray-900 text-white px-4 py-2 h-24"></textarea>
          </template>

          <template x-if="field.type === 'date'">
            <input type="date" class="w-full rounded-lg border border-gray-600 bg-gray-900 text-white px-4 py-2">
          </template>

          <template x-if="field.type === 'single_select'">
            <select class="w-full rounded-lg border border-gray-600 bg-gray-900 text-white px-4 py-2">
              <template x-for="option in field.options" :key="option.name">
                <option x-text="option.name"></option>
              </template>
            </select>
          </template>

          <template x-if="field.type === 'multiple_checkbox'">
            <div class="space-y-2">
              <template x-for="option in field.options" :key="option.name">
                <div class="flex items-center">
                  <input type="checkbox" class="rounded border-gray-600 bg-gray-900 text-blue-600">
                  <span class="ml-2 text-white" x-text="option.name"></span>
                </div>
              </template>
            </div>
          </template>

          <template x-if="['conditionnal', 'list'].includes(field.type)">
            <div class="space-y-4">
              <select class="w-full rounded-lg border border-gray-600 bg-gray-900 text-white px-4 py-2">
                <template x-for="option in field.options" :key="option.name">
                  <option x-text="option.name"></option>
                </template>
              </select>
              <template x-for="cond in field.optionsCond" :key="cond.show">
                <div class="mt-2 pl-4 border-l-2 border-gray-600">
                  <p class="text-sm text-gray-400" x-text="'When ' + cond.show + ':'"></p>
                  <template x-if="cond.type === 'text_input'">
                    <input type="text" :placeholder="cond.name" class="mt-1 w-full rounded-lg border border-gray-600 bg-gray-900 text-white px-4 py-2">
                  </template>
                  <template x-if="cond.type === 'textarea'">
                    <textarea :placeholder="cond.name" class="mt-1 w-full rounded-lg border border-gray-600 bg-gray-900 text-white px-4 py-2 h-24"></textarea>
                  </template>
                </div>
              </template>
            </div>
          </template>
        </div>
      </template>
    </div>
  </div>
</div>
{% endblock %}
