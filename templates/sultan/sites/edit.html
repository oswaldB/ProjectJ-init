
{% extends "sultan/base.html" %}

{% block title %}Site Editor{% endblock %}

{% block alpine_component %}
{
  site: {
    id: null,
    name: '',
    form: '',
    entities: [],
    locations: []
  },
  forms: [],
  entities: [],
  locations: [],
  globalFilter: '',
  get entityGroups() {
    return this.entities.reduce((groups, entity) => {
      const letter = entity.charAt(0).toUpperCase();
      const group = groups.find(g => g.letter === letter);
      if (group) {
        group.items.push(entity);
      } else {
        groups.push({ letter, items: [entity] });
      }
      return groups.sort((a, b) => a.letter.localeCompare(b.letter));
    }, []);
  },
  get locationRegions() {
    const regions = {
      'Europe': ['France', 'Germany', 'UK', 'Spain', 'Italy', 'Switzerland'],
      'Asia': ['China', 'Japan', 'Singapore', 'Hong Kong', 'India'],
      'Americas': ['US', 'Mexico', 'Brazil', 'Argentina'],
      'Middle East': ['UAE', 'Qatar', 'Kuwait', 'Saudi Arabia'],
      'Africa': ['South Africa', 'Egypt', 'Morocco'],
      'Oceania': ['Australia', 'New Zealand']
    };
    
    return Object.entries(regions).map(([name, countries]) => ({
      name,
      items: this.locations.filter(loc => countries.some(c => loc.includes(c)))
    })).filter(region => region.items.length > 0);
  },
  toggleEntityGroup(letter) {
    const group = this.entityGroups.find(g => g.letter === letter);
    if (!group) return;
    
    const allSelected = group.items.every(entity => this.site.entities?.includes(entity));
    group.items.forEach(entity => {
      if (allSelected) {
        const index = this.site.entities.indexOf(entity);
        if (index !== -1) this.site.entities.splice(index, 1);
      } else if (!this.site.entities?.includes(entity)) {
        this.site.entities.push(entity);
      }
    });
  },
  toggleLocationRegion(regionName) {
    const region = this.locationRegions.find(r => r.name === regionName);
    if (!region) return;
    
    const allSelected = region.items.every(loc => this.site.locations?.includes(loc));
    region.items.forEach(location => {
      if (allSelected) {
        const index = this.site.locations.indexOf(location);
        if (index !== -1) this.site.locations.splice(index, 1);
      } else if (!this.site.locations?.includes(location)) {
        this.site.locations.push(location);
      }
    });
  },
  async init() {
    const id = window.location.pathname.split('/').pop();
    if (id === 'new') {
      this.site.id = `sites-${Date.now()}`;
    } else {
      await this.loadSite(id);
    }
    await this.loadForms();
  },
  async loadSite(id) {
    try {
      const response = await fetch(`/api/sultan/sites/${id}`);
      this.site = await response.json();
      if (this.site.form) {
        await this.loadFormData(this.site.form);
      }
    } catch (error) {
      console.error('Failed to load site:', error);
    }
  },
  async loadForms() {
    try {
      const response = await fetch('/api/sultan/forms/list');
      this.forms = await response.json();
    } catch (error) {
      console.error('Failed to load forms:', error);
    }
  },
  async loadFormData(formId) {
    try {
      const response = await fetch(`/api/sultan/forms/${formId}`);
      const formData = await response.json();
      
      // Find location and entity fields
      const locationField = formData.fields.find(f => f.key === 'location');
      const entityField = formData.fields.find(f => f.key === 'entity');
      
      if (locationField) {
        this.locations = locationField.options.map(opt => opt.name);
      }
      if (entityField) {
        this.entities = entityField.options.map(opt => opt.name);
      }
    } catch (error) {
      console.error('Failed to load form data:', error);
    }
  },
  async save() {
    try {
      const response = await fetch('/api/sultan/sites/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          email: localStorage.getItem('user_email'),
          site: this.site
        })
      });
      if (response.ok) {
        window.location.href = '/sultan/sites';
      }
    } catch (error) {
      console.error('Failed to save site:', error);
    }
  },
  saveEntities(entity) {
    if (!this.site.entities) {
      this.site.entities = [];
    }
    const index = this.site.entities.indexOf(entity);
    if (index === -1) {
      this.site.entities.push(entity);
    } else {
      this.site.entities.splice(index, 1);
    }
  },
  saveLocations(location) {
    if (!this.site.locations) {
      this.site.locations = [];
    }
    const index = this.site.locations.indexOf(location);
    if (index === -1) {
      this.site.locations.push(location);
    } else {
      this.site.locations.splice(index, 1);
    }
  }
}
{% endblock %}

{% block content %}
<div class="h-screen bg-gray-900 text-white">
  <!-- Top Bar -->
  <div class="border-b border-gray-700 p-4 flex items-center justify-between bg-gray-800">
    <h1 class="text-2xl font-bold text-white">Site Editor</h1>
    <div class="flex space-x-4">
      <button @click="save()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Save</button>
      <a href="/sultan/sites" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Cancel</a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="p-6 space-y-6">
    <!-- Basic Info -->
    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-300">Site Name</label>
          <input type="text" x-model="site.name" class="mt-1 w-full bg-gray-700 text-white p-2 rounded border border-gray-600">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300">Form</label>
          <select x-model="site.form" @change="loadFormData($event.target.value)" class="mt-1 w-full bg-gray-700 text-white p-2 rounded border border-gray-600">
            <option value="">Select a form</option>
            <template x-for="form in forms" :key="form.id">
              <option :value="form.id" x-text="form.name"></option>
            </template>
          </select>
        </div>
      </div>
    </div>

    <!-- Entities and Locations -->
    <div class="grid grid-cols-2 gap-6">
      <!-- Global Search -->
      <div class="col-span-2 mb-4">
        <input type="text" 
               x-model="globalFilter" 
               placeholder="Search entities or locations..." 
               class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600">
      </div>

      <!-- Entities -->
      <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
        <div class="mb-4 flex justify-between items-center">
          <h3 class="text-lg font-medium">Entities</h3>
          <span class="text-sm text-gray-400" x-text="site.entities?.length + ' selected'"></span>
        </div>
        
        <div class="space-y-4 max-h-[60vh] overflow-y-auto">
          <!-- Group by first letter -->
          <template x-for="group in entityGroups" :key="group.letter">
            <div x-show="group.items.some(entity => !globalFilter || entity.toLowerCase().includes(globalFilter.toLowerCase()))"
                 class="border-b border-gray-700 pb-2">
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-sm font-medium text-gray-400" x-text="group.letter"></h4>
                <button @click="toggleEntityGroup(group.letter)" 
                        class="text-xs text-blue-400 hover:text-blue-300">
                  Select All
                </button>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <template x-for="entity in group.items" :key="entity">
                  <div x-show="!globalFilter || entity.toLowerCase().includes(globalFilter.toLowerCase())" 
                       class="flex items-center">
                    <input type="checkbox" 
                           :checked="site.entities?.includes(entity)"
                           @click="saveEntities(entity)"
                           class="mr-2">
                    <span x-text="entity" class="text-sm"></span>
                  </div>
                </template>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Locations -->
      <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
        <div class="mb-4 flex justify-between items-center">
          <h3 class="text-lg font-medium">Locations</h3>
          <span class="text-sm text-gray-400" x-text="site.locations?.length + ' selected'"></span>
        </div>
        
        <div class="space-y-4 max-h-[60vh] overflow-y-auto">
          <!-- Group by region -->
          <template x-for="region in locationRegions" :key="region.name">
            <div x-show="region.items.some(loc => !globalFilter || loc.toLowerCase().includes(globalFilter.toLowerCase()))"
                 class="border-b border-gray-700 pb-2">
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-sm font-medium text-gray-400" x-text="region.name"></h4>
                <button @click="toggleLocationRegion(region.name)" 
                        class="text-xs text-blue-400 hover:text-blue-300">
                  Select All
                </button>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <template x-for="location in region.items" :key="location">
                  <div x-show="!globalFilter || location.toLowerCase().includes(globalFilter.toLowerCase())" 
                       class="flex items-center">
                    <input type="checkbox" 
                           :checked="site.locations?.includes(location)"
                           @click="saveLocations(location)"
                           class="mr-2">
                    <span x-text="location" class="text-sm"></span>
                  </div>
                </template>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
