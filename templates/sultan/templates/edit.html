
{% extends "sultan/base.html" %}

{% block title %}Template Editor{% endblock %}

{% block alpine_component %}{
  page: 'template-edit',
  template: {
    id: '',
    name: '',
    status: 'draft',
    content: '',
    user_email: 'oswald.bernard@gmail.com',
    last_modified: new Date().toISOString()
  },
  templateId: '',
  state: {
    loading: false,
    saving: false,
    error: null
  },
  async init() {
    const pathParts = window.location.pathname.split('/');
    this.templateId = pathParts[pathParts.length - 1];
    
    if (this.templateId !== 'new') {
      await this.loadTemplate();
    } else {
      this.template.id = 'templates-' + Date.now();
    }
  },
  async loadTemplate() {
    try {
      this.state.loading = true;
      const response = await fetch(`/api/sultan/templates`);
      if (!response.ok) throw new Error('Failed to load templates');
      const templates = await response.json();
      const foundTemplate = templates.find(t => t.id === this.templateId);
      if (foundTemplate) {
        this.template = foundTemplate;
      } else {
        this.state.error = 'Template not found';
      }
    } catch (error) {
      console.error('Failed to load template:', error);
      this.state.error = error.message;
    } finally {
      this.state.loading = false;
    }
  },
  async saveTemplate() {
    try {
      this.state.saving = true;
      this.template.last_modified = new Date().toISOString();
      const response = await fetch('/api/sultan/templates/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ template: this.template })
      });
      if (!response.ok) throw new Error('Failed to save template');
      showNotification('Template saved successfully', 'success');
    } catch (error) {
      console.error('Failed to save template:', error);
      showNotification('Failed to save template', 'error');
    } finally {
      this.state.saving = false;
    }
  }
}{% endblock %}tring();
        
        const response = await fetch('/api/sultan/templates/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ template: this.template })
        });
        
        if (!response.ok) throw new Error('Failed to save template');
        
        showNotification('Template saved successfully', 'success');
      } catch (error) {
        console.error('Failed to save template:', error);
        showNotification('Failed to save template', 'error');
      } finally {
        this.state.saving = false;
      }
    },
    formatDate(date) {
      return new Date(date || Date.now()).toLocaleString();
    }
  }
{% endblock %}

{% block content %}
<div class="p-6">
  <header class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-white">Template Editor</h1>
    <div class="flex space-x-4">
      <button @click="saveTemplate()" 
              :disabled="state.saving"
              class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition disabled:opacity-50">
        <span x-show="!state.saving">Save Template</span>
        <span x-show="state.saving">Saving...</span>
      </button>
      <a href="/sultan/templates" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
        Back to List
      </a>
    </div>
  </header>

  <!-- Loading State -->
  <div x-show="state.loading" class="text-center py-8">
    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-500 mx-auto"></div>
    <p class="text-gray-400 mt-2">Loading template...</p>
  </div>

  <!-- Error State -->
  <div x-show="state.error" class="bg-red-500 bg-opacity-10 border border-red-500 text-red-500 px-4 py-3 rounded mb-6">
    <p x-text="state.error"></p>
  </div>

  <!-- Template Form -->
  <div x-show="!state.loading && !state.error" class="space-y-6">
    <!-- Basic Info -->
    <div class="bg-gray-800 p-6 rounded-lg">
      <h2 class="text-xl font-semibold text-white mb-4">Template Information</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Template Name</label>
          <input type="text" 
                 x-model="template.name" 
                 @input="saveTemplate()"
                 class="w-full bg-gray-700 text-white px-3 py-2 rounded border border-gray-600 focus:outline-none focus:border-red-500"
                 placeholder="Enter template name">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Status</label>
          <select x-model="template.status" 
                  @change="saveTemplate()"
                  class="w-full bg-gray-700 text-white px-3 py-2 rounded border border-gray-600 focus:outline-none focus:border-red-500">
            <option value="draft">Draft</option>
            <option value="prod">Production</option>
            <option value="old version">Old Version</option>
          </select>
        </div>
      </div>
      
      <div class="mt-4 text-sm text-gray-400">
        <p>ID: <span x-text="template.id"></span></p>
        <p>Last Modified: <span x-text="formatDate(template.last_modified)"></span></p>
        <p>Author: <span x-text="template.user_email"></span></p>
      </div>
    </div>

    <!-- Template Content -->
    <div class="bg-gray-800 p-6 rounded-lg">
      <h2 class="text-xl font-semibold text-white mb-4">Template Content</h2>
      
      <textarea x-model="template.content" 
                @input="saveTemplate()"
                class="w-full h-96 bg-gray-700 text-white px-3 py-2 rounded border border-gray-600 focus:outline-none focus:border-red-500 font-mono text-sm"
                placeholder="Enter your template content here..."></textarea>
    </div>
  </div>
</div>

<script>
function showNotification(message, type) {
  // Simple notification system
  const notification = document.createElement('div');
  notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}
</script>
{% endblock %}
